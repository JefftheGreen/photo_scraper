#!/usr/bin/env python3
# -*- coding: utf-8 -*-

from django.test import TestCase
from django.utils import timezone as tz
from scraping.models import *

BLOG_NAME = 'njwight'
BLOG_TITLE = '''NJ Wight's Wild! Life'''
AVATAR_URL = 'https://66.media.tumblr.com/avatar_c0188e624b21_512.png'
BlOG_DESCRIPTION = '''Wildlife photographer with a passion for animals, Africa and ice cream. It's a Wild! Life–live it! All photos ©NJ Wight. Subscribe to NJ Wight's Wild! Life : http://www.njwight.com'''

POST = {'caption': '<p>Nice left hook! Little lions frolicking.</p>', 'reblog_key': 'asOAQOlE', 'type': 'photo', 'recommended_source': None, 'id': 147789058287, 'can_send_in_message': True, 'format': 'html', 'note_count': 313, 'recommended_color': None, 'image_permalink': 'http://njwight.tumblr.com/image/147789058287', 'slug': 'nice-left-hook-little-lions-frolicking', 'tags': ['big cats', 'animals', 'baby animals', 'lions', 'wildlife photography'], 'post_url': 'http://njwight.tumblr.com/post/147789058287/nice-left-hook-little-lions-frolicking', 'highlighted': [], 'state': 'published', 'short_url': 'https://tmblr.co/ZDq_Jy29ewX3l', 'timestamp': 1469174714, 'reblog': {'comment': '<p>Nice left hook! Little lions frolicking.</p>', 'tree_html': ''}, 'trail': [{'is_root_item': True, 'post': {'id': '147789058287'}, 'content': '<p>Nice left hook! Little lions frolicking.</p>', 'blog': {'share_following': False, 'name': 'njwight', 'share_likes': False, 'theme': {'show_avatar': True, 'header_image_focused': 'https://secure.static.tumblr.com/35bc84a09ade73f48f6e1300b9abb370/a0sf8by/Vannfm88o/tumblr_static_tumblr_static__focused_v3.jpg', 'show_header_image': True, 'header_focus_width': 851, 'header_full_height': 786, 'body_font': 'Helvetica Neue', 'show_description': True, 'header_image_scaled': 'https://secure.static.tumblr.com/35bc84a09ade73f48f6e1300b9abb370/a0sf8by/5Kunfm88m/tumblr_static__2048_v2.jpg', 'header_stretch': True, 'header_image': 'https://secure.static.tumblr.com/35bc84a09ade73f48f6e1300b9abb370/a0sf8by/5Kunfm88m/tumblr_static_.jpg', 'show_title': True, 'background_color': '#fcfcfc', 'header_focus_height': 479, 'avatar_shape': 'square', 'title_color': '#444444', 'title_font_weight': 'bold', 'link_color': '#b7b426', 'header_full_width': 1024, 'header_bounds': '150,1024,629,173', 'title_font': 'Gibson'}, 'active': True}, 'content_raw': '<p>Nice left hook! Little lions frolicking.</p>', 'is_current_item': True}], 'summary': 'Nice left hook! Little lions frolicking.', 'notes': [{'avatar_shape': '', 'type': 'like', 'blog_uuid': 'szemi.tumblr.com', 'blog_url': 'http://szemi.tumblr.com/', 'blog_name': 'szemi', 'followed': False, 'timestamp': 1469278670}, {'avatar_shape': '', 'type': 'like', 'blog_uuid': 'pat6904.tumblr.com', 'blog_url': 'http://pat6904.tumblr.com/', 'blog_name': 'pat6904', 'followed': False, 'timestamp': 1469274275}, {'avatar_shape': 'square', 'post_id': '147842027100', 'type': 'reblog', 'blog_uuid': 'driftingpastcircumstances.tumblr.com', 'reblog_parent_blog_name': 'njwight', 'blog_url': 'http://driftingpastcircumstances.tumblr.com/', 'blog_name': 'driftingpastcircumstances', 'followed': False, 'timestamp': 1469273363}, {'avatar_shape': 'circle', 'post_id': '147841996203', 'type': 'reblog', 'blog_uuid': 'hellofurryone.tumblr.com', 'reblog_parent_blog_name': 'wildography', 'blog_url': 'http://hellofurryone.tumblr.com/', 'blog_name': 'hellofurryone', 'followed': False, 'timestamp': 1469273277}, {'avatar_shape': '', 'type': 'like', 'blog_uuid': 'exactlyloudnacho.tumblr.com', 'blog_url': 'http://exactlyloudnacho.tumblr.com/', 'blog_name': 'exactlyloudnacho', 'followed': False, 'timestamp': 1469271570}, {'avatar_shape': 'square', 'type': 'like', 'blog_uuid': 'flyvapnet.tumblr.com', 'blog_url': 'http://flyvapnet.tumblr.com/', 'blog_name': 'flyvapnet', 'followed': False, 'timestamp': 1469271412}, {'avatar_shape': '', 'type': 'like', 'blog_uuid': 'amandaq1214.tumblr.com', 'blog_url': 'http://amandaq1214.tumblr.com/', 'blog_name': 'amandaq1214', 'followed': False, 'timestamp': 1469269353}, {'avatar_shape': '', 'post_id': '147840379290', 'type': 'reblog', 'blog_uuid': 'soonchild.tumblr.com', 'added_text': 'Sweet', 'reblog_parent_blog_name': 'njwight', 'blog_url': 'http://soonchild.tumblr.com/', 'blog_name': 'soonchild', 'followed': False, 'timestamp': 1469268858}, {'avatar_shape': 'square', 'type': 'like', 'blog_uuid': 'jardaz2.tumblr.com', 'blog_url': 'http://jardaz2.tumblr.com/', 'blog_name': 'jardaz2', 'followed': False, 'timestamp': 1469266765}, {'avatar_shape': 'circle', 'type': 'like', 'blog_uuid': 'm-m-w-devil.tumblr.com', 'blog_url': 'http://m-m-w-devil.tumblr.com/', 'blog_name': 'm-m-w-devil', 'followed': False, 'timestamp': 1469264509}, {'avatar_shape': 'circle', 'post_id': '147837990725', 'type': 'reblog', 'blog_uuid': 'xdeathberryx.tumblr.com', 'reblog_parent_blog_name': 'naruforeversasu', 'blog_url': 'http://xdeathberryx.tumblr.com/', 'blog_name': 'xdeathberryx', 'followed': False, 'timestamp': 1469262774}, {'avatar_shape': 'circle', 'type': 'like', 'blog_uuid': 'bleach116607.tumblr.com', 'blog_url': 'http://bleach116607.tumblr.com/', 'blog_name': 'bleach116607', 'followed': False, 'timestamp': 1469262662}, {'avatar_shape': 'square', 'post_id': '147836305599', 'type': 'reblog', 'blog_uuid': 'naruforeversasu.tumblr.com', 'reblog_parent_blog_name': 'njwight', 'blog_url': 'http://naruforeversasu.tumblr.com/', 'blog_name': 'naruforeversasu', 'followed': False, 'timestamp': 1469259030}, {'avatar_shape': 'square', 'type': 'like', 'blog_uuid': 'naruforeversasu.tumblr.com', 'blog_url': 'http://naruforeversasu.tumblr.com/', 'blog_name': 'naruforeversasu', 'followed': False, 'timestamp': 1469259029}, {'avatar_shape': 'circle', 'type': 'like', 'blog_uuid': 'kozue1107.tumblr.com', 'blog_url': 'http://kozue1107.tumblr.com/', 'blog_name': 'kozue1107', 'followed': False, 'timestamp': 1469257982}, {'avatar_shape': '', 'type': 'like', 'blog_uuid': 'ashraysaluja8.tumblr.com', 'blog_url': 'http://ashraysaluja8.tumblr.com/', 'blog_name': 'ashraysaluja8', 'followed': False, 'timestamp': 1469256580}, {'avatar_shape': 'square', 'type': 'like', 'blog_uuid': 'claudio82clod.tumblr.com', 'blog_url': 'http://claudio82clod.tumblr.com/', 'blog_name': 'claudio82clod', 'followed': False, 'timestamp': 1469255534}, {'avatar_shape': 'square', 'post_id': '147834208849', 'type': 'reblog', 'blog_uuid': 'chestercheeta.tumblr.com', 'reblog_parent_blog_name': 'njwight', 'blog_url': 'http://chestercheeta.tumblr.com/', 'blog_name': 'chestercheeta', 'followed': False, 'timestamp': 1469254941}, {'avatar_shape': 'square', 'type': 'like', 'blog_uuid': 'tzbutts.tumblr.com', 'blog_url': 'http://tzbutts.tumblr.com/', 'blog_name': 'tzbutts', 'followed': False, 'timestamp': 1469251681}, {'avatar_shape': 'square', 'post_id': '147831270312', 'type': 'reblog', 'blog_uuid': 'clareficationneeded.tumblr.com', 'reblog_parent_blog_name': 'njwight', 'blog_url': 'http://clareficationneeded.tumblr.com/', 'blog_name': 'clareficationneeded', 'followed': False, 'timestamp': 1469249942}, {'avatar_shape': 'square', 'type': 'like', 'blog_uuid': 'clareficationneeded.tumblr.com', 'blog_url': 'http://clareficationneeded.tumblr.com/', 'blog_name': 'clareficationneeded', 'followed': False, 'timestamp': 1469249940}, {'avatar_shape': '', 'post_id': '147830263277', 'type': 'reblog', 'blog_uuid': 'the-azeroth-punk.tumblr.com', 'reblog_parent_blog_name': 'njwight', 'blog_url': 'http://the-azeroth-punk.tumblr.com/', 'blog_name': 'the-azeroth-punk', 'followed': False, 'timestamp': 1469248336}, {'avatar_shape': '', 'type': 'like', 'blog_uuid': 'nickd1985.tumblr.com', 'blog_url': 'http://nickd1985.tumblr.com/', 'blog_name': 'nickd1985', 'followed': False, 'timestamp': 1469245411}, {'avatar_shape': 'square', 'type': 'like', 'blog_uuid': 'hear-africa.tumblr.com', 'blog_url': 'http://hear-africa.tumblr.com/', 'blog_name': 'hear-africa', 'followed': False, 'timestamp': 1469244835}, {'avatar_shape': 'square', 'type': 'like', 'blog_uuid': 'artwithdog.tumblr.com', 'blog_url': 'http://artwithdog.tumblr.com/', 'blog_name': 'artwithdog', 'followed': False, 'timestamp': 1469242944}, {'avatar_shape': 'square', 'type': 'like', 'blog_uuid': 'nevaeh11love.tumblr.com', 'blog_url': 'http://nevaeh11love.tumblr.com/', 'blog_name': 'nevaeh11love', 'followed': False, 'timestamp': 1469241816}, {'avatar_shape': 'square', 'post_id': '147825820344', 'type': 'reblog', 'blog_uuid': 'aura218.tumblr.com', 'reblog_parent_blog_name': 'njwight', 'blog_url': 'http://aura218.tumblr.com/', 'blog_name': 'aura218', 'followed': False, 'timestamp': 1469241358}, {'avatar_shape': 'square', 'type': 'like', 'blog_uuid': 'bunniiy11.tumblr.com', 'blog_url': 'http://bunniiy11.tumblr.com/', 'blog_name': 'bunniiy11', 'followed': False, 'timestamp': 1469240244}, {'avatar_shape': 'square', 'type': 'like', 'blog_uuid': 'stephmhere.tumblr.com', 'blog_url': 'http://stephmhere.tumblr.com/', 'blog_name': 'stephmhere', 'followed': False, 'timestamp': 1469239192}, {'avatar_shape': 'square', 'post_id': '147822948028', 'type': 'reblog', 'blog_uuid': 'fsallaround.tumblr.com', 'reblog_parent_blog_name': 'njwight', 'blog_url': 'http://fsallaround.tumblr.com/', 'blog_name': 'fsallaround', 'followed': False, 'timestamp': 1469236693}, {'avatar_shape': 'square', 'type': 'like', 'blog_uuid': 'ksiouxw.tumblr.com', 'blog_url': 'http://ksiouxw.tumblr.com/', 'blog_name': 'ksiouxw', 'followed': False, 'timestamp': 1469236509}, {'avatar_shape': 'square', 'type': 'like', 'blog_uuid': 'fanunited.tumblr.com', 'blog_url': 'http://fanunited.tumblr.com/', 'blog_name': 'fanunited', 'followed': False, 'timestamp': 1469236328}, {'avatar_shape': 'square', 'type': 'like', 'blog_uuid': 'eclectick.tumblr.com', 'blog_url': 'http://eclectick.tumblr.com/', 'blog_name': 'eclectick', 'followed': False, 'timestamp': 1469233481}, {'avatar_shape': 'circle', 'type': 'like', 'blog_uuid': 'rainbowstockings-chan.tumblr.com', 'blog_url': 'http://rainbowstockings-chan.tumblr.com/', 'blog_name': 'rainbowstockings-chan', 'followed': False, 'timestamp': 1469233358}, {'avatar_shape': 'square', 'type': 'like', 'blog_uuid': 'sunwendyrain.tumblr.com', 'blog_url': 'http://sunwendyrain.tumblr.com/', 'blog_name': 'sunwendyrain', 'followed': False, 'timestamp': 1469232753}, {'avatar_shape': 'circle', 'type': 'like', 'blog_uuid': 'ineffablyphan.tumblr.com', 'blog_url': 'http://ineffablyphan.tumblr.com/', 'blog_name': 'ineffablyphan', 'followed': False, 'timestamp': 1469232184}, {'avatar_shape': '', 'type': 'like', 'blog_uuid': 'eyes4beauties.tumblr.com', 'blog_url': 'http://eyes4beauties.tumblr.com/', 'blog_name': 'eyes4beauties', 'followed': False, 'timestamp': 1469230867}, {'avatar_shape': 'circle', 'post_id': '147819183619', 'type': 'reblog', 'blog_uuid': 'actualbriansella.tumblr.com', 'reblog_parent_blog_name': 'njwight', 'blog_url': 'http://actualbriansella.tumblr.com/', 'blog_name': 'actualbriansella', 'followed': False, 'timestamp': 1469230562}, {'avatar_shape': 'circle', 'type': 'like', 'blog_uuid': 'hunnyglazedbuttcheeks.tumblr.com', 'blog_url': 'http://hunnyglazedbuttcheeks.tumblr.com/', 'blog_name': 'hunnyglazedbuttcheeks', 'followed': False, 'timestamp': 1469229980}, {'avatar_shape': 'square', 'type': 'like', 'blog_uuid': 'beebakae.tumblr.com', 'blog_url': 'http://beebakae.tumblr.com/', 'blog_name': 'beebakae', 'followed': False, 'timestamp': 1469229410}, {'avatar_shape': 'square', 'type': 'like', 'blog_uuid': 'ayliinsworld.tumblr.com', 'blog_url': 'http://ayliinsworld.tumblr.com/', 'blog_name': 'ayliinsworld', 'followed': False, 'timestamp': 1469229212}, {'avatar_shape': '', 'type': 'like', 'blog_uuid': 'martukky.tumblr.com', 'blog_url': 'http://martukky.tumblr.com/', 'blog_name': 'martukky', 'followed': False, 'timestamp': 1469227432}, {'avatar_shape': '', 'type': 'like', 'blog_uuid': 'tysongrace.tumblr.com', 'blog_url': 'http://tysongrace.tumblr.com/', 'blog_name': 'tysongrace', 'followed': False, 'timestamp': 1469226515}, {'avatar_shape': 'square', 'type': 'like', 'blog_uuid': 'mrbaterdondotto.tumblr.com', 'blog_url': 'http://mrbaterdondotto.tumblr.com/', 'blog_name': 'mrbaterdondotto', 'followed': False, 'timestamp': 1469226049}, {'avatar_shape': '', 'type': 'like', 'blog_uuid': 'mauiswift.tumblr.com', 'blog_url': 'http://mauiswift.tumblr.com/', 'blog_name': 'mauiswift', 'followed': False, 'timestamp': 1469224378}, {'avatar_shape': 'square', 'type': 'like', 'blog_uuid': 'cheezayballz.tumblr.com', 'blog_url': 'http://cheezayballz.tumblr.com/', 'blog_name': 'cheezayballz', 'followed': False, 'timestamp': 1469224340}, {'avatar_shape': 'square', 'type': 'like', 'blog_uuid': 'kylieempirecxc.tumblr.com', 'blog_url': 'http://kylieempirecxc.tumblr.com/', 'blog_name': 'kylieempirecxc', 'followed': False, 'timestamp': 1469223424}, {'avatar_shape': 'circle', 'post_id': '147813788646', 'type': 'reblog', 'blog_uuid': 'billabaggins.tumblr.com', 'reblog_parent_blog_name': 'njwight', 'blog_url': 'http://billabaggins.tumblr.com/', 'blog_name': 'billabaggins', 'followed': False, 'timestamp': 1469222267}, {'avatar_shape': 'circle', 'post_id': '147813697864', 'type': 'reblog', 'blog_uuid': 'theroadtogetthere.tumblr.com', 'reblog_parent_blog_name': 'njwight', 'blog_url': 'http://theroadtogetthere.tumblr.com/', 'blog_name': 'theroadtogetthere', 'followed': False, 'timestamp': 1469222126}, {'avatar_shape': '', 'type': 'like', 'blog_uuid': 'kgeorge1234.tumblr.com', 'blog_url': 'http://kgeorge1234.tumblr.com/', 'blog_name': 'kgeorge1234', 'followed': False, 'timestamp': 1469221850}], 'date': '2016-07-22 08:05:14 GMT', 'photos': [{'exif': {'Aperture': 'f/2.8', 'FocalLength': '300mm', 'Exposure': '1/800th', 'ISO': 2500, 'Camera': 'Canon EOS 5D Mark III'}, 'caption': '', 'original_size': {'height': 871, 'width': 1280, 'url': 'https://66.media.tumblr.com/b39bd96d0194bfc9579cc2d0484c2f2e/tumblr_oapigqNQKp1qbko1eo1_1280.jpg'}, 'alt_sizes': [{'height': 871, 'width': 1280, 'url': 'https://66.media.tumblr.com/b39bd96d0194bfc9579cc2d0484c2f2e/tumblr_oapigqNQKp1qbko1eo1_1280.jpg'}, {'height': 340, 'width': 500, 'url': 'https://66.media.tumblr.com/b39bd96d0194bfc9579cc2d0484c2f2e/tumblr_oapigqNQKp1qbko1eo1_500.jpg'}, {'height': 272, 'width': 400, 'url': 'https://66.media.tumblr.com/b39bd96d0194bfc9579cc2d0484c2f2e/tumblr_oapigqNQKp1qbko1eo1_400.jpg'}, {'height': 170, 'width': 250, 'url': 'https://67.media.tumblr.com/b39bd96d0194bfc9579cc2d0484c2f2e/tumblr_oapigqNQKp1qbko1eo1_250.jpg'}, {'height': 68, 'width': 100, 'url': 'https://67.media.tumblr.com/b39bd96d0194bfc9579cc2d0484c2f2e/tumblr_oapigqNQKp1qbko1eo1_100.jpg'}, {'height': 75, 'width': 75, 'url': 'https://66.media.tumblr.com/b39bd96d0194bfc9579cc2d0484c2f2e/tumblr_oapigqNQKp1qbko1eo1_75sq.jpg'}]}], 'blog_name': 'njwight'}
PHOTO_URL = 'https://66.media.tumblr.com/b39bd96d0194bfc9579cc2d0484c2f2e/tumblr_oapigqNQKp1qbko1eo1_1280.jpg'
PHOTO_CAPTION = '<p>Nice left hook! Little lions frolicking.</p>'


class EffectTest(TestCase):

    def setUp(self):
        blog = TumblrBlog.from_api(BLOG_NAME)
        blog.save()
        photo_data = Photo.from_tumblr_api(POST, blog)
        photo = photo_data[0]['photo']
        raw_tags = photo_data[0]['raw tags']
        photo.save()
        photo.tags_from_ary(raw_tags)
        photo.get_words()
        photo.make_ngrams()

    def test_blog(self):
        blog = TumblrBlog.objects.get(name=BLOG_TITLE)
        assert blog.url == 'http://' + BLOG_NAME + '.tumblr.com/'
        assert blog.name == BLOG_TITLE
        assert blog.last_scraped < tz.now()
        assert blog.description == BlOG_DESCRIPTION
        assert blog.avatar_url == AVATAR_URL

    def test_photos(self):
        assert len(Photo.objects.all()) == 1
        photo = Photo.objects.get(id=1)
        assert photo.tags.all().count() == 5
        assert photo.photo_url == PHOTO_URL
        assert photo.caption == PHOTO_CAPTION
        assert photo.title == ''
        tags = ['big cats', 'animals', 'baby animals', 'lions',
                'wildlife photography']
        for t in tags:
            assert Tag.objects.filter(tag_str=t).exists()
            assert Tag.objects.get(tag_str=t) in photo.tags.all()
        for t in Tag.objects.all():
            assert t.tag_str in tags
        words = ['big', 'cat', 'animal', 'baby', 'lion', 'wildlife',
                 'photography', 'nice', 'left', 'hook', 'little', 'frolic']
        for w in Word.objects.all():
            assert w.word_str in words
        for w in words:
            assert Word.objects.filter(word_str=w).exists()
        ngrams = ['big cat', 'baby animal', 'wildlife photography',
                  'nice left', 'left hook', 'hook little', 'little lion',
                  'lion frolic', 'nice left hook', 'left hook little',
                  'hook little lion', 'little lion frolic']
        for n in Ngram.objects.all():
            assert n.expression in ngrams
        for n in ngrams:
            assert Ngram.objects.filter(expression=n).exists()

